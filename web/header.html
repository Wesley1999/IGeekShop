<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <title>极客商城首页</title>
    <link rel="stylesheet" href="css/bootstrap.min.css" type="text/css">
    <script src="/js/jquery.cookie.js" type="text/javascript"></script>
    <script src="/js/bootstrap.min.js" type="text/javascript"></script>

    <script>
        $(function () {

            function getCookie ( name )
            {
                //获取name在Cookie中起止位置
                var start = document.cookie.indexOf(name+"=") ;

                if ( start != -1 )
                {
                    start = start + name.length + 1 ;
                    //获取value的终止位置
                    var end = document.cookie.indexOf(";", start) ;
                    if ( end == -1 )
                        end = document.cookie.length ;
                    //截获cookie的value值,并返回
                    return unescape(document.cookie.substring(start,end)) ;
                }
                return "" ;
            }

            function getUrlParam(name) {
                var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
                var r = window.location.search.substr(1).match(reg);
                if (r != null) return decodeURI(r[2]); return null;
            }

            // 如果有keyword参数，将其渲染到搜索框
            $("#keyword").val(getUrlParam("keyword"))

            // 渲染导航栏分分类信息
            $.ajax({
                type: "POST",
                url: "/api/category/get_categories.action",
                dataType: "json",
                success: function (returnData) {
                    for (i = 0; i < returnData.data.length; i++) {
                        categoryId = returnData.data[i].categoryId;
                        categoryName = returnData.data[i].name;
                        price = returnData.data[i].price;
                        $("#navigationBar").append("<li><a href=\"category.html?categoryId=" + categoryId + "&pageNum=1\">" + categoryName + "</a>")
                    }
                }
            })

            // 渲染登录信息
            $.ajax({
                type: "POST",
                url: "/api/user/get_current_user.action",
                dataType: "json",
                success: function (returnData) {
                    if (returnData.status === 0) {
                        // 已登录
                        username = returnData.data.username;
                        $("#userInfo").append("<li style='color: red'> 欢迎您，" + username + "</li>\n" +
                            "            <li><a href=\"#\" onclick='signOut()'>退出</a></li>\n" +
                            "            <li><a href=\"cart.html\">购物车</a></li>\n" +
                            "            <li><a href=\"/order_list.html?pageNum=1\">我的订单</a></li>")
                    } else {
                        // 未登录，先尝试自动登录
                        if (getCookie("md5Md5Password") !== "") {
                            $.ajax({
                                type: "POST",
                                url: "/api/user/auto_sign_in.action",
                                dataType: "json",
                                success: function (returnData) {
                                    if (returnData.status === 0) {
                                        $.ajax({
                                            type: "POST",
                                            url: "/api/user/get_current_user.action",
                                            dataType: "json",
                                            success: function (returnData) {
                                                if (returnData.status === 0) {
                                                    username = returnData.data.username;
                                                    $("#userInfo").append("<li style='color: red'> 欢迎您，" + username + "</li>\n" +
                                                        "            <li><a href=\"#\" onclick='signOut()'>退出</a></li>\n" +
                                                        "            <li><a href=\"cart.html\">购物车</a></li>\n" +
                                                        "            <li><a href=\"/order_list.html?pageNum=1\">我的订单</a></li>")
                                                }
                                            }
                                        })
                                    } else {
                                        // 自动登录失败
                                        $("#userInfo").append("<li class=\"userInfo\"><a href=\"login.html\">登录</a></li>\n" +
                                            "            <li class=\"userInfo\"><a href=\"register.html\">注册</a></li>\n" +
                                            "            <li><a href=\"cart.html\">购物车</a></li>\n" +
                                            "            <li><a href=\"/order_list.html?pageNum=1\">我的订单</a></li>")
                                    }
                                }
                            })
                        } else {
                            // 不要求自动登录
                            $("#userInfo").append("<li class=\"userInfo\"><a href=\"login.html\">登录</a></li>\n" +
                                "            <li class=\"userInfo\"><a href=\"register.html\">注册</a></li>\n" +
                                "            <li><a href=\"cart.html\">购物车</a></li>\n" +
                                "            <li><a href=\"/order_list.html?pageNum=1\">我的订单</a></li>")
                        }
                    }
                }
            })
        });

        // 退出登录
        function signOut() {
            $.ajax({
                type: "POST",
                url: "/api/user/sign_out.action",
                dataType: "json",
                success: function (returnData) {
                    if (returnData.status === 0) {
                        location.href = "/"
                    }
                }
            })
        }
    </script>

</head>
<body>
<div class="container-fluid" style="width: 1500px; text-align: center">
    <!-- 登录 注册 购物车... -->
    <div class="container-fluid">
        <div class="col-md-4">
            <img src="img/logo.png"/>
        </div>
        <div class="col-md-5">
            <img src="img/header.png"/>
        </div>
        <div class="col-md-3" style="padding-top:20px">
            <ol class="list-inline" id="userInfo">
            </ol>
        </div>
    </div>

    <!-- 导航条 -->
    <div class="container-fluid">
        <nav class="navbar navbar-inverse">
            <div class="container-fluid">
                <!-- Brand and toggle get grouped for better mobile display -->
                <div class="navbar-header">
                    <a class="navbar-brand" href="/">首页</a>
                </div>

                <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                    <ul class="nav navbar-nav" id="navigationBar">
                        <!--<li><a href=\"category_list.html?categoryId=1\"></a></li>-->
                    </ul>
                    <form class="navbar-form navbar-right" role="search" action="search.html" method="get">
                        <div class="form-group">
                            <input type="text" class="form-control" placeholder="请输入要搜索的商品名称..." name="keyword" id="keyword">
                        </div>
                        <button type="submit" class="btn btn-default">搜索</button>
                    </form>
                </div>
            </div>
        </nav>
    </div>
</div>

</body>
</html>


